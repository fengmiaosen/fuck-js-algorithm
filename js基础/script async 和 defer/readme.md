# `script` 标签的 `async` 和 `defer` 属性详解

在 HTML 中，`<script>` 标签用于加载和执行 JavaScript。默认情况下，当浏览器遇到一个 `<script>` 标签时，它会暂停 HTML 的解析，立即下载并执行脚本，然后才继续解析页面的其余部分。这种行为可能会阻塞页面的渲染，导致用户看到一个空白页面，从而影响用户体验。

为了解决这个问题，HTML5 为 `<script>` 标签引入了两个布尔属性：`async` 和 `defer`。它们都告诉浏览器异步下载脚本，但执行时机和行为有所不同。

---

## 属性对比

| 特性 | 默认 (无属性) | `async` | `defer` |
| :--- | :--- | :--- | :--- |
| **HTML 解析** | 遇到 `script` 时暂停 | 不会暂停，并行下载 | 不会暂停，并行下载 |
| **脚本下载** | 阻塞解析 | 异步下载 | 异步下载 |
| **脚本执行** | 下载后立即执行，阻塞解析 | 下载后立即执行，阻塞解析 | HTML 解析完毕后，`DOMContentLoaded` 事件前执行 |
| **执行顺序** | 按在文档中的顺序 | 下载完成顺序，不保证 | 按在文档中的顺序 |
| **适用场景** | 脚本很小，或必须在后续 DOM 前执行 | 独立的第三方脚本，如分析、广告 | 依赖 DOM 或需要按顺序执行的脚本 |

### 可视化时间线

![Timeline](https://i.stack.imgur.com/2G32v.png)
*   **绿色线**: HTML 解析
*   **蓝色线**: 脚本下载
*   **红色线**: 脚本执行

---

## `async` (Asynchronous)

`async` 属性告诉浏览器立即开始异步下载脚本，同时继续解析 HTML。一旦脚本下载完成，浏览器会暂停 HTML 解析，立即执行该脚本。执行完毕后，再继续解析 HTML。

```html
<script async src="analytics.js"></script>
<script async src="ads.js"></script>
```

### 优缺点

**优点:**
*   **非阻塞下载**: 脚本的下载不会阻塞 HTML 的解析，提高了页面加载速度。
*   **尽早执行**: 脚本下载后会尽快执行，适合那些希望尽早运行的独立脚本。

**缺点:**
*   **阻塞执行**: 虽然下载是异步的，但执行仍然会阻塞 HTML 解析。如果脚本很大，执行时间长，依然会造成页面卡顿。
*   **执行顺序不保证**: 多个 `async` 脚本的执行顺序取决于哪个先下载完成，而不是它们在 HTML 中的顺序。这使得它不适合有依赖关系的脚本。例如，如果 `ads.js` 依赖于 `analytics.js` 中的某个函数，就无法保证 `analytics.js` 一定先执行。
*   **DOM 不完整**: 执行脚本时，不能保证完整的 DOM 已经构建完成。因此，在 `async` 脚本中操作 DOM 元素可能会失败。

### 应用场景

`async` 最适合用于那些**完全独立、无依赖关系**的脚本，且希望它们能尽快执行。
*   **网站分析脚本**: 如 Google Analytics，它独立于网站的其他功能。
*   **广告脚本**: 广告的加载和显示不应阻塞主要内容的呈现。
*   **社交媒体分享按钮**等小型、独立的第三方插件。

---

## `defer` (Deferred)

`defer` 属性也告诉浏览器异步下载脚本，但它的执行被推迟到整个 HTML 文档解析完毕之后，但在 `DOMContentLoaded` 事件触发之前。

```html
<script defer src="jquery.js"></script>
<script defer src="main.js"></script>
```

### 优缺点

**优点:**
*   **非阻塞下载**: 和 `async` 一样，脚本下载不阻塞 HTML 解析。
*   **非阻塞执行 (相对解析而言)**: 脚本的执行不会中断 HTML 的解析过程，因为它总是在解析完成后才开始。
*   **保证执行顺序**: 多个 `defer` 脚本会严格按照它们在 HTML 中出现的顺序来执行。这对于有依赖关系的脚本（如先加载库，再加载主逻辑）至关重要。
*   **完整的 DOM**: 执行时，整个 DOM 树已经构建完成，可以安全地进行 DOM 操作。

**缺点:**
*   **执行较晚**: 脚本需要等到整个文档解析完毕才能执行，对于一些需要尽早执行的逻辑可能不是最佳选择。

### 应用场景

`defer` 是目前大多数场景下的**最佳实践和首选方案**。
*   **需要操作 DOM 的脚本**: 因为可以保证 DOM 已经准备就绪。
*   **有依赖关系的脚本**: 例如，先引入一个库文件，再引入一个依赖该库的自定义脚本。
*   **所有非核心、可以稍后执行的脚本**，以优先保证用户能尽快看到渲染出的页面内容。

---

## 总结与最佳实践

1.  **无属性**: 仅用于那些必须在文档解析过程中立即执行的、并且没有外部依赖的小脚本。通常应避免在 `<head>` 中使用。
2.  **`async`**: 用于独立的第三方脚本，执行顺序和 DOM 可用性不重要。例如：分析、广告。
3.  **`defer`**: 用于需要整个 DOM 或依赖其他脚本的场景，执行顺序很重要。这是大多数情况下的**推荐选项**。

**经验法则:**
*   如果脚本是模块化的，并且不依赖于任何其他脚本，使用 `async`。
*   如果脚本依赖于 DOM 内容或其他脚本的执行，使用 `defer`。
*   如果脚本很小并且被 `async` 脚本所依赖，那么可以将其内联并放在 `async` 脚本的前面，不加任何属性。

通过合理使用 `async` 和 `defer`，可以显著优化网页的加载性能和用户体验。